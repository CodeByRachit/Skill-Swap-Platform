<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Swap Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom styles for dynamic Tailwind classes */
        /* These are placeholders. Tailwind JIT mode handles dynamic classes better.
           For a simple CDN setup, ensure all potential classes are present in the HTML/CSS.
           The approach below is for demonstration. For production, consider purging unused CSS
           or using a build step for Tailwind. */
        .bg-indigo-700 { background-color: #4338ca; }
        .text-indigo-800 { color: #3730a3; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .border-indigo-500 { border-color: #6366f1; }
        .text-indigo-600 { color: #4f46e5; }
        .bg-indigo-200 { background-color: #e0e7ff; }
        .border-indigo-400 { border-color: #818cf8; }

        .bg-purple-700 { background-color: #6b21a8; }
        .text-purple-800 { color: #581c87; }
        .bg-purple-600 { background-color: #7c3aed; }
        .hover\:bg-purple-700:hover { background-color: #6b21a8; }
        .border-purple-500 { border-color: #a855f7; }
        .text-purple-600 { color: #9333ea; }
        .bg-purple-200 { background-color: #e9d5ff; }
        .border-purple-400 { border-color: #c084fc; }

        .bg-green-700 { background-color: #15803d; }
        .text-green-800 { color: #166534; }
        .bg-green-600 { background-color: #22c55e; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .border-green-500 { border-color: #22c55e; }
        .text-green-600 { color: #16a34a; }
        .bg-green-200 { background-color: #dcfce7; }
        .border-green-400 { border-color: #4ade80; }

        .bg-blue-100 { background-color: #dbeafe; }
        .border-blue-500 { border-color: #3b82f6; }
        .text-blue-700 { color: #1d4ed8; }

        .bg-pink-100 { background-color: #fce7f3; }
        .border-pink-500 { border-color: #ec4899; }
        .text-pink-700 { color: #be185d; }

        .bg-teal-100 { background-color: #ccfbf1; }
        .border-teal-500 { border-color: #14b8a6; }
        .text-teal-700 { color: #0f766e; }

        /* General styles */
        .rounded-md { border-radius: 0.375rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .p-4 { padding: 1rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .max-w-4xl { max-width: 56rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .border-l-4 { border-left-width: 4px; }
        .container { width: 100%; }
        @media (min-width: 640px) { .container { max-width: 640px; } }
        @media (min-width: 768px) { .container { max-width: 768px; } }
        @media (min-width: 1024px) { .container { max-width: 1024px; } }
        @media (min-width: 1280px) { .container { max-width: 1280px; } }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .flex-wrap { flex-wrap: wrap; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-medium { font-weight: 500; }
        .space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .min-h-screen { min-height: 100vh; }
        .p-6 { padding: 1.5rem; }
        .my-8 { margin-top: 2rem; margin-bottom: 2rem; }
        .max-w-2xl { max-width: 42rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .block { display: block; }
        .w-full { width: 100%; }
        .border-gray-300 { border-color: #d1d5db; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .focus\:border-indigo-500:focus { border-color: #6366f1; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: #6366f1; }
        .p-2 { padding: 0.5rem; }
        .h-4 { height: 1rem; }
        .w-4 { width: 1rem; }
        .focus\:ring-offset-2:focus { --tw-ring-offset-width: 2px; }
        .text-white { color: #fff; }
        .border-transparent { border-color: transparent; }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .rounded-full { border-radius: 9999px; }
        .object-cover { object-fit: cover; }
        .w-24 { width: 6rem; }
        .h-24 { height: 6rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .list-disc { list-style-type: disc; }
        .list-inside { list-style-position: inside; }
        .mt-auto { margin-top: auto; }
        .grid { display: grid; }
        .gap-6 { gap: 1.5rem; }
        .gap-4 { gap: 1rem; }
        .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .bg-opacity-50 { background-color: rgba(0, 0, 0, 0.5); }
        .z-50 { z-index: 50; }
        .max-h-\[70vh\] { max-height: 70vh; }
        .overflow-y-auto { overflow-y: auto; }
        .absolute { position: absolute; }
        .top-4 { top: 1rem; }
        .right-4 { right: 1rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .text-red-600 { color: #dc2626; }
        .text-yellow-600 { color: #eab308; }
        .text-green-600 { color: #22c55e; }
        .bg-red-100 { background-color: #fee2e2; }
        .text-red-800 { color: #991b1b; }
        .bg-green-100 { background-color: #dcfce7; }
        .text-green-800 { color: #166534; }
        .bg-yellow-100 { background-color: #fef9c3; }
        .text-yellow-800 { color: #a16207; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .text-gray-800 { color: #1f2937; }
        .bg-gray-500 { background-color: #6b7280; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .bg-blue-600 { background-color: #2563eb; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .bg-blue-100 { background-color: #dbeafe; }
        .border-blue-500 { border-color: #3b82f6; }
        .text-blue-700 { color: #1d4ed8; }
        .bg-purple-100 { background-color: #f3e8ff; }
        .text-purple-700 { color: #7e22ce; }
        .border-purple-500 { border-color: #a855f7; }
        .bg-pink-600 { background-color: #db2777; }
        .hover\:bg-pink-700:hover { background-color: #be185d; }
        .bg-teal-600 { background-color: #0d9488; }
        .hover\:bg-teal-700:hover { background-color: #0f766e; }
        .bg-lime-600 { background-color: #65a30d; }
        .hover\:bg-lime-700:hover { background-color: #4d7c0f; }

        /* Explicitly define classes for dynamic theme colors for Tailwind JIT to pick them up */
        .bg-indigo-700, .text-indigo-900, .bg-gray-100, .text-gray-900, .bg-indigo-600, .hover\:bg-indigo-700, .border-indigo-500, .text-indigo-600, .bg-indigo-200, .border-indigo-400 {}
        .bg-purple-700, .text-gray-900, .bg-gray-50, .bg-purple-600, .hover\:bg-purple-700, .border-purple-500, .text-purple-600, .bg-purple-200, .border-purple-400 {}
        .bg-green-700, .text-gray-900, .bg-gray-100, .bg-green-600, .hover\:bg-green-700, .border-green-500, .text-green-600, .bg-green-200, .border-green-400 {}
        .bg-blue-100, .border-blue-500, .text-blue-700 {}
        .bg-pink-100, .border-pink-500, .text-pink-700 {}
        .bg-teal-100, .border-teal-500, .text-teal-700 {}
        .bg-lime-100, .border-lime-500, .text-lime-700 {}
        .bg-fuchsia-100, .border-fuchsia-500, .text-fuchsia-700 {}
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Define the base URL for API calls
        const BASE_URL = 'http://127.0.0.1:5000';

        // Define themes in JavaScript to be accessible by the frontend logic
        const themes = {
            indigo: {
                primary: 'indigo',
                secondary: 'blue',
                accent: 'purple',
                text: 'gray-900',
                bg: 'gray-100',
                headerBg: 'indigo-700',
                headerText: 'white',
                buttonBg: 'indigo-600',
                buttonHover: 'indigo-700',
            },
            purple: {
                primary: 'purple',
                secondary: 'pink',
                accent: 'fuchsia',
                text: 'gray-900',
                bg: 'gray-50',
                headerBg: 'purple-700',
                headerText: 'white',
                buttonBg: 'purple-600',
                buttonHover: 'purple-700',
            },
            green: {
                primary: 'green',
                secondary: 'teal',
                accent: 'lime',
                text: 'gray-900',
                bg: 'gray-100',
                headerBg: 'green-700',
                headerText: 'white',
                buttonBg: 'green-600',
                buttonHover: 'green-700',
            },
        };

        const { useState, useEffect, createContext, useContext, useCallback } = React;
        const ReactDOM = window.ReactDOM;

        const AuthContext = createContext(null);
        const ThemeContext = createContext(null);

        const AuthProvider = ({ children }) => {
            const [currentUser, setCurrentUser] = useState(null);
            const [userId, setUserId] = useState(localStorage.getItem('skillSwapUserId') || null);
            const [userProfile, setUserProfile] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false); // To track if initial auth check is done

            // Function to fetch user profile
            const fetchUserProfile = useCallback(async (id) => {
                if (!id) return null;
                try {
                    const response = await fetch(`${BASE_URL}/api/profile/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    } else {
                        const errorData = await response.json();
                        console.error("Failed to fetch user profile:", errorData.error || response.statusText);
                        return null;
                    }
                } catch (error) {
                    console.error("Network error fetching user profile:", error.message);
                    return null;
                }
            }, []);

            // Initial auth check on component mount
            useEffect(() => {
                const checkAuth = async () => {
                    const storedUserId = localStorage.getItem('skillSwapUserId');
                    if (storedUserId) {
                        const profile = await fetchUserProfile(storedUserId);
                        if (profile) {
                            setCurrentUser({ uid: storedUserId });
                            setUserId(storedUserId);
                            setUserProfile(profile);
                        } else {
                            // If profile fetch fails, clear stored ID
                            localStorage.removeItem('skillSwapUserId');
                            setUserId(null);
                            setCurrentUser(null);
                            setUserProfile(null);
                        }
                    }
                    setIsAuthReady(true); // Mark auth check as complete
                };
                checkAuth();
            }, [fetchUserProfile]);

            // Function to handle user login
            const login = useCallback(async (name, password) => {
                try {
                    const response = await fetch(`${BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        localStorage.setItem('skillSwapUserId', data.userId);
                        setCurrentUser({ uid: data.userId });
                        setUserId(data.userId);
                        setUserProfile(data.userProfile);
                        return { success: true, message: data.message };
                    } else {
                        return { success: false, error: data.error || response.statusText };
                    }
                } catch (error) {
                    console.error("Network or API error during login:", error.message);
                    return { success: false, error: `Network error: ${error.message}. Please ensure the backend server is running.` };
                }
            }, []);

            // Function to handle user signup
            const signup = useCallback(async (name, password, location, skillsOffered, skillsWanted, availability, isPublic) => {
                try {
                    const response = await fetch(`${BASE_URL}/api/auth/signup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, password, location, skillsOffered, skillsWanted, availability, isPublic })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        localStorage.setItem('skillSwapUserId', data.userId);
                        setCurrentUser({ uid: data.userId });
                        setUserId(data.userId);
                        setUserProfile(data.userProfile);
                        return { success: true, message: data.message };
                    } else {
                        return { success: false, error: data.error || response.statusText };
                    }
                } catch (error) {
                    console.error("Network or API error during signup:", error.message);
                    return { success: false, error: `Network error: ${error.message}. Please ensure the backend server is running.` };
                }
            }, []);

            // Function to handle user logout
            const logout = useCallback(() => {
                localStorage.removeItem('skillSwapUserId');
                setCurrentUser(null);
                setUserId(null);
                setUserProfile(null);
                // No need to call backend for logout in this stateless token-based approach
            }, []);

            // Re-fetch user profile if userId changes (e.g., after login/signup)
            useEffect(() => {
                if (userId && isAuthReady) {
                    fetchUserProfile(userId).then(profile => {
                        if (profile) {
                            setUserProfile(profile);
                        }
                    });
                }
            }, [userId, isAuthReady, fetchUserProfile]);

            const authValue = { currentUser, userId, userProfile, isAuthReady, login, signup, logout };
            const currentThemeName = userProfile?.theme || 'indigo';
            const currentTheme = themes[currentThemeName] || themes.indigo;

            return (
                <AuthContext.Provider value={authValue}>
                    <ThemeContext.Provider value={currentTheme}>
                        {children}
                    </ThemeContext.Provider>
                </AuthContext.Provider>
            );
        };

        const useAuth = () => useContext(AuthContext);
        const useTheme = () => useContext(ThemeContext);

        const LoadingSpinner = () => {
            const theme = useTheme();
            return (
                <div className={`flex justify-center items-center h-screen bg-${theme.bg}`}>
                    <div className={`animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-${theme.primary}-500`}></div>
                    <p className={`ml-4 text-lg text-${theme.text}`}>Loading...</p>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            const theme = useTheme();
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative">
                        <h3 className={`text-xl font-semibold text-${theme.text} mb-4`}>{title}</h3>
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                        >
                            &times;
                        </button>
                        <div className="max-h-[70vh] overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const MessageModal = ({ isOpen, onClose, message }) => {
            const theme = useTheme();
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Notification">
                    <p className={`text-${theme.text}`}>{message}</p>
                    <div className="mt-6 flex justify-end">
                        <button
                            onClick={onClose}
                            className={`px-6 py-2 bg-${theme.primary}-600 text-white rounded-md hover:bg-${theme.primary}-700 focus:outline-none focus:ring-2 focus:ring-${theme.primary}-500 focus:ring-offset-2`}
                        >
                            OK
                        </button>
                    </div>
                </Modal>
            );
        };

        const LoginForm = ({ onLoginSuccess, onSwitchToSignup }) => {
            const { login } = useAuth();
            const theme = useTheme();
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                const result = await login(name, password);
                if (result.success) {
                    setMessage(result.message);
                    setIsMessageModalOpen(true);
                    onLoginSuccess();
                } else {
                    setMessage(result.error);
                    setIsMessageModalOpen(true);
                }
            };

            return (
                <div className={`bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto my-12 text-${theme.text}`}>
                    <h2 className={`text-3xl font-bold text-${theme.primary}-800 mb-6 text-center`}>Login</h2>
                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                            <label htmlFor="login-name" className="block text-sm font-medium text-gray-700">Username</label>
                            <input
                                type="text"
                                id="login-name"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="login-password" className="block text-sm font-medium text-gray-700">Password</label>
                            <input
                                type="password"
                                id="login-password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-${theme.buttonBg} hover:bg-${theme.buttonHover} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.primary}-500`}
                        >
                            Sign In
                        </button>
                    </form>
                    <p className={`mt-6 text-center text-sm text-${theme.text}`}>
                        Don't have an account?{' '}
                        <button
                            onClick={onSwitchToSignup}
                            className={`font-medium text-${theme.primary}-600 hover:text-${theme.primary}-500`}
                        >
                            Sign Up
                        </button>
                    </p>
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </div>
            );
        };

        const SignupForm = ({ onSignupSuccess, onSwitchToLogin }) => {
            const { signup } = useAuth();
            const theme = useTheme();
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [location, setLocation] = useState('');
            const [skillsOffered, setSkillsOffered] = useState('');
            const [skillsWanted, setSkillsWanted] = useState('');
            const [availability, setAvailability] = useState('');
            const [isPublic, setIsPublic] = useState(true);
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                if (password !== confirmPassword) {
                    setMessage('Passwords do not match.');
                    setIsMessageModalOpen(true);
                    return;
                }

                const result = await signup(
                    name,
                    password,
                    location,
                    skillsOffered.split(',').map(s => s.trim()).filter(s => s),
                    skillsWanted.split(',').map(s => s.trim()).filter(s => s),
                    availability,
                    isPublic
                );

                if (result.success) {
                    setMessage(result.message);
                    setIsMessageModalOpen(true);
                    onSignupSuccess();
                } else {
                    setMessage(result.error);
                    setIsMessageModalOpen(true);
                }
            };

            return (
                <div className={`bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto my-12 text-${theme.text}`}>
                    <h2 className={`text-3xl font-bold text-${theme.primary}-800 mb-6 text-center`}>Sign Up</h2>
                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                            <label htmlFor="signup-name" className="block text-sm font-medium text-gray-700">Username</label>
                            <input
                                type="text"
                                id="signup-name"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="signup-password" className="block text-sm font-medium text-gray-700">Password</label>
                            <input
                                type="password"
                                id="signup-password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="confirm-password" className="block text-sm font-medium text-gray-700">Confirm Password</label>
                            <input
                                type="password"
                                id="confirm-password"
                                value={confirmPassword}
                                onChange={(e) => setConfirmPassword(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="signup-location" className="block text-sm font-medium text-gray-700">Location (Optional)</label>
                            <input
                                type="text"
                                id="signup-location"
                                value={location}
                                onChange={(e) => setLocation(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                            />
                        </div>
                        <div>
                            <label htmlFor="signup-skills-offered" className="block text-sm font-medium text-gray-700">Skills Offered (comma-separated, optional)</label>
                            <input
                                type="text"
                                id="signup-skills-offered"
                                value={skillsOffered}
                                onChange={(e) => setSkillsOffered(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., Photoshop, Web Design"
                            />
                        </div>
                        <div>
                            <label htmlFor="signup-skills-wanted" className="block text-sm font-medium text-gray-700">Skills Wanted (comma-separated, optional)</label>
                            <input
                                type="text"
                                id="signup-skills-wanted"
                                value={skillsWanted}
                                onChange={(e) => setSkillsWanted(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., Spanish Lessons, Yoga"
                            />
                        </div>
                        <div>
                            <label htmlFor="signup-availability" className="block text-sm font-medium text-gray-700">Availability (Optional)</label>
                            <input
                                type="text"
                                id="signup-availability"
                                value={availability}
                                onChange={(e) => setAvailability(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., Weekends, Evenings"
                            />
                        </div>
                        <div className="flex items-center">
                            <input
                                type="checkbox"
                                id="signup-is-public"
                                checked={isPublic}
                                onChange={(e) => setIsPublic(e.target.checked)}
                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                            />
                            <label htmlFor="signup-is-public" className="ml-2 block text-sm font-medium text-gray-700">Make Profile Public</label>
                        </div>
                        <button
                            type="submit"
                            className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-${theme.buttonBg} hover:bg-${theme.buttonHover} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.primary}-500`}
                        >
                            Sign Up
                        </button>
                    </form>
                    <p className={`mt-6 text-center text-sm text-${theme.text}`}>
                        Already have an account?{' '}
                        <button
                            onClick={onSwitchToLogin}
                            className={`font-medium text-${theme.primary}-600 hover:text-${theme.primary}-500`}
                        >
                            Sign In
                        </button>
                    </p>
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </div>
            );
        };

        const ProfileEditor = ({ userProfile, userId, onProfileUpdate }) => {
            const theme = useTheme();
            const [name, setName] = useState(userProfile?.name || '');
            const [location, setLocation] = useState(userProfile?.location || '');
            const [profilePhoto, setProfilePhoto] = useState(userProfile?.profile_photo || 'https://placehold.co/100x100/A0AEC0/FFFFFF?text=User');
            const [skillsOffered, setSkillsOffered] = useState(userProfile?.skills_offered?.join(', ') || '');
            const [skillsWanted, setSkillsWanted] = useState(userProfile?.skills_wanted?.join(', ') || '');
            const [availability, setAvailability] = useState(userProfile?.availability || '');
            const [isPublic, setIsPublic] = useState(userProfile?.is_public ?? true);
            const [selectedTheme, setSelectedTheme] = useState(userProfile?.theme || 'indigo');
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);

            useEffect(() => {
                if (userProfile) {
                    setName(userProfile.name || '');
                    setLocation(userProfile.location || '');
                    setProfilePhoto(userProfile.profile_photo || 'https://placehold.co/100x100/A0AEC0/FFFFFF?text=User');
                    setSkillsOffered(userProfile.skills_offered?.join(', ') || '');
                    setSkillsWanted(userProfile.skills_wanted?.join(', ') || '');
                    setAvailability(userProfile.availability || '');
                    setIsPublic(userProfile.is_public ?? true);
                    setSelectedTheme(userProfile.theme || 'indigo');
                }
            }, [userProfile]);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!userId) {
                    setMessage('User not authenticated.');
                    setIsMessageModalOpen(true);
                    return;
                }

                try {
                    const response = await fetch(`${BASE_URL}/api/profile/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            location,
                            profilePhoto,
                            skillsOffered: skillsOffered.split(',').map(s => s.trim()).filter(s => s),
                            skillsWanted: skillsWanted.split(',').map(s => s.trim()).filter(s => s),
                            availability,
                            isPublic,
                            theme: selectedTheme,
                        }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage('Profile updated successfully!');
                        setIsMessageModalOpen(true);
                        onProfileUpdate(data); // Update parent state with new profile
                    } else {
                        console.error("Error updating profile:", data.error);
                        setMessage(`Failed to update profile: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error updating profile:", error.message);
                    setMessage(`Failed to update profile: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [userId, name, location, profilePhoto, skillsOffered, skillsWanted, availability, isPublic, selectedTheme, onProfileUpdate]);

            return (
                <div className={`bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto my-8 text-${theme.text}`}>
                    <h2 className={`text-2xl font-bold text-${theme.primary}-800 mb-6`}>Edit Profile</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-700">Name</label>
                            <input
                                type="text"
                                id="name"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="location" className="block text-sm font-medium text-gray-700">Location (Optional)</label>
                            <input
                                type="text"
                                id="location"
                                value={location}
                                onChange={(e) => setLocation(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                            />
                        </div>
                        <div>
                            <label htmlFor="profilePhoto" className="block text-sm font-medium text-gray-700">Profile Photo URL (Optional)</label>
                            <input
                                type="url"
                                id="profilePhoto"
                                value={profilePhoto}
                                onChange={(e) => setProfilePhoto(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., https://example.com/your-photo.jpg"
                            />
                            {profilePhoto && (
                                <img src={profilePhoto} alt="Profile Preview" className="mt-2 w-24 h-24 rounded-full object-cover border border-gray-300" onError={(e) => e.target.src = 'https://placehold.co/100x100/A0AEC0/FFFFFF?text=User'} />
                            )}
                        </div>
                        <div>
                            <label htmlFor="skillsOffered" className="block text-sm font-medium text-gray-700">Skills Offered (comma-separated)</label>
                            <input
                                type="text"
                                id="skillsOffered"
                                value={skillsOffered}
                                onChange={(e) => setSkillsOffered(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., Photoshop, Web Design, Cooking"
                            />
                        </div>
                        <div>
                            <label htmlFor="skillsWanted" className="block text-sm font-medium text-gray-700">Skills Wanted (comma-separated)</label>
                            <input
                                type="text"
                                id="skillsWanted"
                                value={skillsWanted}
                                onChange={(e) => setSkillsWanted(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., Spanish Lessons, Car Repair, Yoga"
                            />
                        </div>
                        <div>
                            <label htmlFor="availability" className="block text-sm font-medium text-gray-700">Availability</label>
                            <input
                                type="text"
                                id="availability"
                                value={availability}
                                onChange={(e) => setAvailability(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                placeholder="e.g., Weekends, Evenings, Flexible"
                            />
                        </div>
                        <div className="flex items-center">
                            <input
                                type="checkbox"
                                id="isPublic"
                                checked={isPublic}
                                onChange={(e) => setIsPublic(e.target.checked)}
                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                            />
                            <label htmlFor="isPublic" className="ml-2 block text-sm font-medium text-gray-700">Make Profile Public</label>
                        </div>
                        {/* Theme Selector */}
                        <div>
                            <label htmlFor="themeSelector" className="block text-sm font-medium text-gray-700">Choose Theme</label>
                            <select
                                id="themeSelector"
                                value={selectedTheme}
                                onChange={(e) => setSelectedTheme(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                            >
                                {Object.keys(themes).map((themeName) => (
                                    <option key={themeName} value={themeName}>
                                        {themeName.charAt(0).toUpperCase() + themeName.slice(1)}
                                    </option>
                                ))}
                            </select>
                        </div>
                        <button
                            type="submit"
                            className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.buttonBg} hover:bg-${theme.buttonHover} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.primary}-500`}
                        >
                            Save Profile
                        </button>
                    </form>
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </div>
            );
        };

        const UserCard = ({ user, onSendSwapRequest, currentUserId }) => {
            const theme = useTheme();
            return (
                <div className={`bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center text-${theme.text}`}>
                    <img
                        src={user.profile_photo}
                        alt={`${user.name}'s profile`}
                        className={`w-24 h-24 rounded-full object-cover mb-4 border-2 border-${theme.primary}-400`}
                        onError={(e) => e.target.src = 'https://placehold.co/100x100/A0AEC0/FFFFFF?text=User'}
                    />
                    <h3 className={`text-xl font-semibold text-${theme.primary}-800 mb-2`}>{user.name}</h3>
                    <p className="text-gray-600 text-sm mb-1">{user.location}</p>
                    <p className="text-gray-600 text-sm mb-4">ID: {user.id}</p>
                    <div className="text-left w-full mb-4">
                        <p className="text-sm font-medium text-gray-700">Offers:</p>
                        <ul className="list-disc list-inside text-gray-600 text-sm">
                            {user.skills_offered.length > 0 ? user.skills_offered.map((skill, i) => <li key={i}>{skill}</li>) : <li key="no-offered">N/A</li>}
                        </ul>
                        <p className="text-sm font-medium text-gray-700 mt-2">Wants:</p>
                        <ul className="list-disc list-inside text-gray-600 text-sm">
                            {user.skills_wanted.length > 0 ? user.skills_wanted.map((skill, i) => <li key={i}>{skill}</li>) : <li key="no-wanted">N/A</li>}
                        </ul>
                        <p className="text-sm font-medium text-gray-700 mt-2">Availability: <span className="font-normal">{user.availability || 'N/A'}</span></p>
                    </div>
                    {user.id !== currentUserId && (
                        <button
                            onClick={() => onSendSwapRequest(user.id, user.name)}
                            className={`mt-auto px-4 py-2 bg-${theme.buttonBg} text-white rounded-md hover:bg-${theme.buttonHover} focus:outline-none focus:ring-2 focus:ring-${theme.primary}-500 focus:ring-offset-2`}
                        >
                            Request Swap
                        </button>
                    )}
                </div>
            );
        };

        const BrowseUsers = ({ onSendSwapRequest }) => {
            const { userId, userProfile } = useAuth();
            const theme = useTheme();
            const [users, setUsers] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);

            useEffect(() => {
                const fetchUsers = async () => {
                    setLoading(true);
                    try {
                        const response = await fetch(`${BASE_URL}/api/users?searchTerm=${encodeURIComponent(searchTerm)}`);
                        const data = await response.json();
                        if (response.ok) {
                            // Sort users to show current user's profile first if it's public
                            const sortedUsers = data.sort((a, b) => {
                                if (a.id === userId) return -1;
                                if (b.id === userId) return 1;
                                return 0;
                            });
                            setUsers(sortedUsers);
                        } else {
                            setMessage(`Failed to load users: ${data.error || response.statusText}`);
                            setIsMessageModalOpen(true);
                        }
                    } catch (error) {
                        console.error("Network error fetching users:", error.message);
                        setMessage(`Failed to load users: ${error.message}. Please ensure the backend server is running.`);
                        setIsMessageModalOpen(true);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchUsers();
            }, [searchTerm, userId]); // Re-fetch when searchTerm or userId changes

            if (loading) return <LoadingSpinner />;
            if (!userProfile) return <p className={`text-center text-${theme.text} mt-8`}>Please complete your profile to browse other users.</p>;
            if (userProfile.is_banned) return <p className="text-center text-red-600 font-bold text-xl mt-8">You have been banned from the platform.</p>;

            return (
                <div className="p-6">
                    <h2 className={`text-3xl font-bold text-${theme.primary}-800 mb-6 text-center`}>Browse & Find Skills</h2>
                    <div className="mb-8 max-w-xl mx-auto">
                        <input
                            type="text"
                            placeholder="Search by skill or name (e.g., Photoshop, John Doe)"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                        />
                    </div>
                    {users.length === 0 ? (
                        <p className={`text-center text-${theme.text}`}>No public profiles found or matching your search.</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {users.map(user => (
                                <UserCard
                                    key={user.id}
                                    user={user}
                                    onSendSwapRequest={onSendSwapRequest}
                                    currentUserId={userId}
                                />
                            ))}
                        </div>
                    )}
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </div>
            );
        };

        const SwapRequestForm = ({ isOpen, onClose, recipientId, recipientName }) => {
            const { userId, userProfile } = useAuth();
            const theme = useTheme();
            const [skillOffered, setSkillOffered] = useState('');
            const [skillWanted, setSkillWanted] = useState('');
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);

            useEffect(() => {
                if (userProfile) {
                    setSkillOffered(userProfile.skills_offered?.[0] || '');
                    setSkillWanted(userProfile.skills_wanted?.[0] || '');
                }
            }, [userProfile]);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!userId || !userProfile) {
                    setMessage('You must be logged in and have a profile to send a swap request.');
                    setIsMessageModalOpen(true);
                    return;
                }
                if (!skillOffered || !skillWanted) {
                    setMessage('Please specify a skill you offer and a skill you want.');
                    setIsMessageModalOpen(true);
                    return;
                }
                if (userId === recipientId) {
                    setMessage('You cannot send a swap request to yourself.');
                    setIsMessageModalOpen(true);
                    return;
                }

                try {
                    const response = await fetch(`${BASE_URL}/api/swap_requests`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            senderId: userId,
                            senderName: userProfile.name,
                            receiverId: recipientId,
                            receiverName: recipientName,
                            skillOffered,
                            skillWanted,
                        }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage('Swap request sent successfully!');
                        setIsMessageModalOpen(true);
                        onClose();
                    } else {
                        console.error("Error sending swap request:", data.error);
                        setMessage(`Failed to send swap request: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error sending swap request:", error.message);
                    setMessage(`Failed to send swap request: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [userId, userProfile, skillOffered, skillWanted, recipientId, recipientName, onClose]);

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Request Swap with ${recipientName}`}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="skillOffered" className="block text-sm font-medium text-gray-700">Skill you are offering</label>
                            <input
                                type="text"
                                id="skillOffered"
                                value={skillOffered}
                                onChange={(e) => setSkillOffered(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                list="skillsOfferedList"
                                required
                            />
                            {userProfile?.skills_offered && (
                                <datalist id="skillsOfferedList">
                                    {userProfile.skills_offered.map((skill, index) => (
                                        <option key={index} value={skill} />
                                    ))}
                                </datalist>
                            )}
                        </div>
                        <div>
                            <label htmlFor="skillWanted" className="block text-sm font-medium text-gray-700">Skill you are requesting</label>
                            <input
                                type="text"
                                id="skillWanted"
                                value={skillWanted}
                                onChange={(e) => setSkillWanted(e.target.value)}
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                list="skillsWantedList"
                                required
                            />
                            {userProfile?.skills_wanted && (
                                <datalist id="skillsWantedList">
                                    {userProfile.skills_wanted.map((skill, index) => (
                                        <option key={index} value={skill} />
                                    ))}
                                </datalist>
                            )}
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className={`px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.buttonBg} hover:bg-${theme.buttonHover} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.primary}-500`}
                            >
                                Send Request
                            </button>
                        </div>
                    </form>
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </Modal>
            );
        };

        const SwapRequests = () => {
            const { userId, userProfile } = useAuth();
            const theme = useTheme();
            const [requests, setRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);
            const [showFeedbackModal, setShowFeedbackModal] = useState(false);
            const [currentSwapForFeedback, setCurrentSwapForFeedback] = useState(null);

            const fetchRequests = useCallback(async () => {
                if (!userId) {
                    setLoading(false); // Stop loading if no user ID
                    return;
                }
                setLoading(true);
                try {
                    const response = await fetch(`${BASE_URL}/api/swap_requests/${userId}`);
                    const data = await response.json();
                    if (response.ok) {
                        setRequests(data);
                    } else {
                        setMessage(`Failed to load requests: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error fetching swap requests:", error.message);
                    setMessage(`Failed to load requests: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                } finally {
                    setLoading(false);
                }
            }, [userId]);

            useEffect(() => {
                fetchRequests();
                // Set up a polling mechanism to simulate real-time updates
                const interval = setInterval(fetchRequests, 5000); // Poll every 5 seconds
                return () => clearInterval(interval);
            }, [fetchRequests]);

            const handleStatusUpdate = useCallback(async (requestId, newStatus) => {
                try {
                    const response = await fetch(`${BASE_URL}/api/swap_requests/${requestId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage(`Request ${newStatus} successfully!`);
                        setIsMessageModalOpen(true);
                        if (newStatus === 'accepted') {
                            const acceptedReq = requests.find(req => req.id === requestId);
                            if (acceptedReq) {
                                setCurrentSwapForFeedback(acceptedReq);
                                setShowFeedbackModal(true);
                            }
                        }
                        fetchRequests(); // Re-fetch requests to update UI
                    } else {
                        console.error(`Error updating request status to ${newStatus}:`, data.error);
                        setMessage(`Failed to ${newStatus} request: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error(`Network error updating request status to ${newStatus}:`, error.message);
                    setMessage(`Failed to ${newStatus} request: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [requests, fetchRequests]);

            const handleDeleteRequest = useCallback(async (requestId) => {
                try {
                    const response = await fetch(`${BASE_URL}/api/swap_requests/${requestId}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        setMessage('Request deleted successfully!');
                        setIsMessageModalOpen(true);
                        fetchRequests(); // Re-fetch requests to update UI
                    } else {
                        const data = await response.json();
                        console.error("Error deleting request:", data.error);
                        setMessage(`Failed to delete request: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error deleting request:", error.message);
                    setMessage(`Failed to delete request: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [fetchRequests]);

            const handleFeedbackSubmit = useCallback(async (swapId, rating, comment) => {
                try {
                    if (!currentSwapForFeedback) {
                        setMessage('No swap selected for feedback.');
                        setIsMessageModalOpen(true);
                        return;
                    }
                    const response = await fetch(`${BASE_URL}/api/feedback`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            swapRequestId: swapId,
                            giverId: userId,
                            receiverId: currentSwapForFeedback.receiver_id === userId ? currentSwapForFeedback.sender_id : currentSwapForFeedback.receiver_id,
                            rating,
                            comment,
                        }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage('Feedback submitted successfully!');
                        setIsMessageModalOpen(true);
                        setShowFeedbackModal(false);
                        setCurrentSwapForFeedback(null);
                    } else {
                        console.error("Error submitting feedback:", data.error);
                        setMessage(`Failed to submit feedback: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error submitting feedback:", error.message);
                    setMessage(`Failed to submit feedback: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [userId, currentSwapForFeedback]);

            if (loading) return <LoadingSpinner />;
            if (!userProfile) return <p className={`text-center text-${theme.text} mt-8`}>Please complete your profile to view swap requests.</p>;
            if (userProfile.is_banned) return <p className="text-center text-red-600 font-bold text-xl mt-8">You have been banned from the platform.</p>;

            const pendingRequests = requests.filter(req => req.status === 'pending');
            const acceptedRequests = requests.filter(req => req.status === 'accepted');
            const rejectedRequests = requests.filter(req => req.status === 'rejected');

            return (
                <div className="p-6">
                    <h2 className={`text-3xl font-bold text-${theme.primary}-800 mb-6 text-center`}>Your Swap Requests</h2>

                    <div className="mb-8">
                        <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Pending Requests</h3>
                        {pendingRequests.length === 0 ? (
                            <p className={`text-${theme.text}`}>No pending swap requests.</p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {pendingRequests.map(req => (
                                    <div key={req.id} className="bg-white rounded-lg shadow-md p-4 border border-yellow-300">
                                        <p className={`font-medium text-${theme.text}`}>
                                            {req.sender_id === userId ? `You offered ${req.skill_offered} to ${req.receiver_name} for ${req.skill_wanted}` :
                                                                       `${req.sender_name} offered ${req.skill_offered} for your ${req.skill_wanted}`}
                                        </p>
                                        <p className="text-sm text-gray-600 mt-1">Status: <span className="font-semibold text-yellow-600">Pending</span></p>
                                        <p className="text-xs text-gray-500">Requested on: {new Date(req.created_at).toLocaleDateString()}</p>
                                        <div className="mt-3 flex space-x-2">
                                            {req.receiver_id === userId && (
                                                <>
                                                    <button
                                                        onClick={() => handleStatusUpdate(req.id, 'accepted')}
                                                        className={`px-3 py-1 bg-${theme.primary}-600 text-white rounded-md text-sm hover:bg-${theme.primary}-700`}
                                                    >
                                                        Accept
                                                    </button>
                                                    <button
                                                        onClick={() => handleStatusUpdate(req.id, 'rejected')}
                                                        className="px-3 py-1 bg-red-600 text-white rounded-md text-sm hover:bg-red-700"
                                                    >
                                                        Reject
                                                    </button>
                                                </>
                                            )}
                                            {req.sender_id === userId && (
                                                <button
                                                    onClick={() => handleDeleteRequest(req.id)}
                                                    className="px-3 py-1 bg-gray-500 text-white rounded-md text-sm hover:bg-gray-600"
                                                >
                                                    Delete Request
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="mb-8">
                        <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Accepted Swaps</h3>
                        {acceptedRequests.length === 0 ? (
                            <p className={`text-${theme.text}`}>No accepted swap requests.</p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {acceptedRequests.map(req => (
                                    <div key={req.id} className="bg-white rounded-lg shadow-md p-4 border border-green-300">
                                        <p className={`font-medium text-${theme.text}`}>
                                            {req.sender_id === userId ? `You offered ${req.skill_offered} to ${req.receiver_name} for ${req.skill_wanted}` :
                                                                       `${req.sender_name} offered ${req.skill_offered} for your ${req.skill_wanted}`}
                                        </p>
                                        <p className="text-sm text-gray-600 mt-1">Status: <span className="font-semibold text-green-600">Accepted</span></p>
                                        <p className="text-xs text-gray-500">Accepted on: {new Date(req.created_at).toLocaleDateString()}</p>
                                        <div className="mt-3">
                                            <button
                                                onClick={() => { setCurrentSwapForFeedback(req); setShowFeedbackModal(true); }}
                                                className={`px-3 py-1 bg-${theme.secondary}-600 text-white rounded-md text-sm hover:bg-${theme.secondary}-700`}
                                            >
                                                Give Feedback
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="mb-8">
                        <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Rejected Swaps</h3>
                        {rejectedRequests.length === 0 ? (
                            <p className={`text-${theme.text}`}>No rejected swap requests.</p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {rejectedRequests.map(req => (
                                    <div key={req.id} className="bg-white rounded-lg shadow-md p-4 border border-red-300">
                                        <p className={`font-medium text-${theme.text}`}>
                                            {req.sender_id === userId ? `You offered ${req.skill_offered} to ${req.receiver_name} for ${req.skill_wanted}` :
                                                                       `${req.sender_name} offered ${req.skill_offered} for your ${req.skill_wanted}`}
                                        </p>
                                        <p className="text-sm text-gray-600 mt-1">Status: <span className="font-semibold text-red-600">Rejected</span></p>
                                        <p className="text-xs text-gray-500">Rejected on: {new Date(req.created_at).toLocaleDateString()}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <FeedbackModal
                        isOpen={showFeedbackModal}
                        onClose={() => setShowFeedbackModal(false)}
                        onSubmit={handleFeedbackSubmit}
                        swap={currentSwapForFeedback}
                    />
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </div>
            );
        };

        const FeedbackModal = ({ isOpen, onClose, onSubmit, swap }) => {
            const theme = useTheme();
            const [rating, setRating] = useState(5);
            const [comment, setComment] = useState('');
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    setRating(5);
                    setComment('');
                }
            }, [isOpen]);

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                if (!swap) {
                    setMessage('No swap selected for feedback.');
                    setIsMessageModalOpen(true);
                    return;
                }
                onSubmit(swap.id, rating, comment);
                onClose();
            }, [onSubmit, onClose, rating, comment, swap]);

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Give Feedback">
                    {swap && (
                        <p className={`mb-4 text-${theme.text}`}>
                            Feedback for swap: <strong>{swap.sender_name}</strong> offered <em>{swap.skill_offered}</em> for <strong>{swap.receiver_name}</strong>'s <em>{swap.skill_wanted}</em>.
                        </p>
                    )}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="rating" className="block text-sm font-medium text-gray-700">Rating (1-5)</label>
                            <input
                                type="range"
                                id="rating"
                                min="1"
                                max="5"
                                value={rating}
                                onChange={(e) => setRating(parseInt(e.target.value))}
                                className="mt-1 w-full"
                            />
                            <p className={`text-center text-lg font-bold text-${theme.primary}-600`}>{rating}</p>
                        </div>
                        <div>
                            <label htmlFor="comment" className="block text-sm font-medium text-gray-700">Comment (Optional)</label>
                            <textarea
                                id="comment"
                                value={comment}
                                onChange={(e) => setComment(e.target.value)}
                                rows="4"
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                            ></textarea>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className={`px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.buttonBg} hover:bg-${theme.buttonHover}`}
                            >
                                Submit Feedback
                            </button>
                        </div>
                    </form>
                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </Modal>
            );
        };

        const AdminPanel = () => {
            const { userProfile } = useAuth();
            const theme = useTheme();
            const [users, setUsers] = useState([]);
            const [swapRequests, setSwapRequests] = useState([]);
            const [feedbackLogs, setFeedbackLogs] = useState([]);
            const [platformMessage, setPlatformMessage] = useState('');
            const [message, setMessage] = useState('');
            const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('users');

            const fetchAdminData = useCallback(async () => {
                if (!userProfile?.is_admin) return;
                try {
                    const [usersRes, swapsRes, feedbackRes, msgRes] = await Promise.all([
                        fetch(`${BASE_URL}/api/admin/users`),
                        fetch(`${BASE_URL}/api/admin/swap_requests`),
                        fetch(`${BASE_URL}/api/feedback`), // Reusing get_all_feedback
                        fetch(`${BASE_URL}/api/admin/platform_message`)
                    ]);

                    const [usersData, swapsData, feedbackData, msgData] = await Promise.all([
                        usersRes.json(),
                        swapsRes.json(),
                        feedbackRes.json(),
                        msgRes.json()
                    ]);

                    if (usersRes.ok) setUsers(usersData); else console.error("Failed to fetch admin users:", usersData.error || usersRes.statusText);
                    if (swapsRes.ok) setSwapRequests(swapsData); else console.error("Failed to fetch admin swaps:", swapsData.error || swapsRes.statusText);
                    if (feedbackRes.ok) setFeedbackLogs(feedbackData); else console.error("Failed to fetch admin feedback:", feedbackData.error || feedbackRes.statusText);
                    if (msgRes.ok) setPlatformMessage(msgData.message || ''); else console.error("Failed to fetch platform message:", msgData.error || msgRes.statusText);

                } catch (error) {
                    console.error("Network error fetching admin data:", error.message);
                    setMessage(`Failed to load admin data: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [userProfile]);

            useEffect(() => {
                fetchAdminData();
                const interval = setInterval(fetchAdminData, 10000); // Poll admin data every 10 seconds
                return () => clearInterval(interval);
            }, [fetchAdminData]);

            const handleBanUser = useCallback(async (userIdToBan, isBannedStatus) => {
                try {
                    const response = await fetch(`${BASE_URL}/api/admin/users/${userIdToBan}/ban`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isBanned: isBannedStatus ? 1 : 0 }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage(data.message);
                        setIsMessageModalOpen(true);
                        fetchAdminData(); // Re-fetch data
                    } else {
                        console.error("Error banning user:", data.error);
                        setMessage(`Failed to update ban status: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error banning user:", error.message);
                    setMessage(`Failed to update ban status: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [fetchAdminData]);

            const handleSendPlatformMessage = useCallback(async () => {
                try {
                    const response = await fetch(`${BASE_URL}/api/admin/platform_message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: platformMessage }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setMessage(data.message);
                        setIsMessageModalOpen(true);
                        fetchAdminData(); // Re-fetch data
                    } else {
                        console.error("Error sending platform message:", data.error);
                        setMessage(`Failed to send message: ${data.error || response.statusText}`);
                        setIsMessageModalOpen(true);
                    }
                } catch (error) {
                    console.error("Network error sending platform message:", error.message);
                    setMessage(`Failed to send message: ${error.message}. Please ensure the backend server is running.`);
                    setIsMessageModalOpen(true);
                }
            }, [platformMessage, fetchAdminData]);

            const handleDownloadReport = useCallback((reportType) => {
                let data;
                let filename;
                switch (reportType) {
                    case 'userActivity':
                        data = users.map(u => ({
                            id: u.id,
                            name: u.name,
                            location: u.location,
                            isPublic: u.is_public,
                            isBanned: u.is_banned,
                            createdAt: u.created_at,
                        }));
                        filename = 'user_activity_report.json';
                        break;
                    case 'feedbackLogs':
                        data = feedbackLogs.map(f => ({
                            id: f.id,
                            swapRequestId: f.swap_request_id,
                            giverId: f.giver_id,
                            receiverId: f.receiver_id,
                            rating: f.rating,
                            comment: f.comment,
                            createdAt: f.created_at,
                        }));
                        filename = 'feedback_logs_report.json';
                        break;
                    case 'swapStats':
                        const swapCounts = swapRequests.reduce((acc, req) => {
                            acc[req.status] = (acc[req.status] || 0) + 1;
                            return acc;
                        }, {});
                        data = {
                            totalSwaps: swapRequests.length,
                            ...swapCounts,
                            pendingSwaps: swapRequests.filter(req => req.status === 'pending').length,
                            acceptedSwaps: swapRequests.filter(req => req.status === 'accepted').length,
                            rejectedSwaps: swapRequests.filter(req => req.status === 'rejected').length,
                            deletedSwaps: swapRequests.filter(req => req.status === 'deleted').length,
                        };
                        filename = 'swap_stats_report.json';
                        break;
                    default:
                        return;
                }

                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setMessage(`Downloaded ${filename}`);
                setIsMessageModalOpen(true);
            }, [users, feedbackLogs, swapRequests]);

            if (!userProfile?.is_admin) {
                return <p className="text-center text-red-600 font-bold text-xl mt-8">Access Denied: You are not an administrator.</p>;
            }

            return (
                <div className={`p-6 text-${theme.text}`}>
                    <h2 className={`text-3xl font-bold text-${theme.primary}-800 mb-6 text-center`}>Admin Panel</h2>

                    <div className="mb-6 border-b border-gray-200">
                        <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                            {['users', 'swaps', 'feedback', 'messages', 'reports'].map((tab) => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`${
                                        activeTab === tab
                                            ? `border-${theme.primary}-500 text-${theme.primary}-600`
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    } whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
                                >
                                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                </button>
                            ))}
                        </nav>
                    </div>

                    {activeTab === 'users' && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Manage Users</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>ID</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Name</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Skills Offered</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Skills Wanted</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Status</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {users.map(user => (
                                            <tr key={user.id}>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{user.id}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{user.name}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{user.skills_offered?.join(', ') || 'N/A'}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{user.skills_wanted?.join(', ') || 'N/A'}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                    {user.is_banned ? <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Banned</span> :
                                                                   <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button
                                                        onClick={() => handleBanUser(user.id, !user.is_banned)}
                                                        className={`px-3 py-1 rounded-md text-white text-xs mr-2 ${user.is_banned ? `bg-${theme.primary}-500 hover:bg-${theme.primary}-600` : `bg-red-500 hover:bg-red-600`}`}
                                                    >
                                                        {user.is_banned ? 'Unban' : 'Ban'}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'swaps' && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Monitor Swaps</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Request ID</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Sender</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Receiver</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Offered</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Wanted</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {swapRequests.map(req => (
                                            <tr key={req.id}>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{req.id}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{req.sender_name} ({req.sender_id.substring(0,6)}...)</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{req.receiver_name} ({req.receiver_id.substring(0,6)}...)</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{req.skill_offered}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{req.skill_wanted}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                        req.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                        req.status === 'accepted' ? 'bg-green-100 text-green-800' :
                                                        req.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {req.status}
                                                    </span>
                                                </td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{new Date(req.created_at).toLocaleDateString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'feedback' && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Feedback Logs</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Feedback ID</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Swap ID</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Giver ID</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Receiver ID</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Rating</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Comment</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium text-${theme.text} uppercase tracking-wider`}>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {feedbackLogs.map(feedback => (
                                            <tr key={feedback.id}>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{feedback.id}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{feedback.swap_request_id.substring(0,6)}...</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{feedback.giver_id.substring(0,6)}...</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{feedback.receiver_id.substring(0,6)}...</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{feedback.rating}/5</td>
                                                <td className={`px-6 py-4 text-sm text-${theme.text} max-w-xs truncate`}>{feedback.comment || 'N/A'}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-${theme.text}`}>{new Date(feedback.created_at).toLocaleDateString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'messages' && (
                        <div className="bg-white rounded-lg shadow-md p-6 max-w-xl mx-auto">
                            <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Send Platform-Wide Message</h3>
                            <textarea
                                value={platformMessage}
                                onChange={(e) => setPlatformMessage(e.target.value)}
                                rows="5"
                                className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 mb-4"
                                placeholder="Enter message to all users..."
                            ></textarea>
                            <button
                                onClick={handleSendPlatformMessage}
                                className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.buttonBg} hover:bg-${theme.buttonHover} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.primary}-500`}
                            >
                                Send Message
                            </button>
                        </div>
                    )}

                    {activeTab === 'reports' && (
                        <div className="bg-white rounded-lg shadow-md p-6 max-w-xl mx-auto text-center">
                            <h3 className={`text-2xl font-semibold text-${theme.primary}-700 mb-4`}>Download Reports</h3>
                            <div className="space-y-4">
                                <button
                                    onClick={() => handleDownloadReport('userActivity')}
                                    className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.secondary}-600 hover:bg-${theme.secondary}-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.secondary}-500`}
                                >
                                    Download User Activity Report (JSON)
                                </button>
                                <button
                                    onClick={() => handleDownloadReport('feedbackLogs')}
                                    className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.secondary}-600 hover:bg-${theme.secondary}-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.secondary}-500`}
                                >
                                    Download Feedback Logs Report (JSON)
                                </button>
                                <button
                                    onClick={() => handleDownloadReport('swapStats')}
                                    className={`w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-${theme.secondary}-600 hover:bg-${theme.secondary}-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${theme.secondary}-500`}
                                >
                                    Download Swap Statistics Report (JSON)
                                </button>
                            </div>
                        </div>
                    )}

                    <MessageModal isOpen={isMessageModalOpen} onClose={() => setIsMessageModalOpen(false)} message={message} />
                </div>
            );
        };

        const App = () => {
            const { currentUser, userId, userProfile, isAuthReady, logout } = useAuth();
            const theme = useTheme();
            const [currentPage, setCurrentPage] = useState('browse');
            const [showAuthForm, setShowAuthForm] = useState('login'); // 'login' or 'signup'
            const [showSwapRequestModal, setShowSwapRequestModal] = useState(false);
            const [selectedRecipientId, setSelectedRecipientId] = useState(null);
            const [selectedRecipientName, setSelectedRecipientName] = useState('');
            const [platformWideMessage, setPlatformWideMessage] = useState('');
            const [appMessage, setAppMessage] = useState('');
            const [isAppMessageModalOpen, setIsAppMessageModalOpen] = useState(false);

            useEffect(() => {
                const fetchPlatformMessage = async () => {
                    try {
                        const response = await fetch(`${BASE_URL}/api/admin/platform_message`);
                        const data = await response.json();
                        if (response.ok) {
                            setPlatformWideMessage(data.message || '');
                        } else {
                            console.error("Error fetching platform message:", data.error || response.statusText);
                        }
                    } catch (error) {
                        console.error("Network error fetching platform message:", error.message);
                    }
                };
                fetchPlatformMessage();
                const interval = setInterval(fetchPlatformMessage, 15000); // Poll every 15 seconds
                return () => clearInterval(interval);
            }, []);

            const handleSendSwapRequest = useCallback((recipientId, recipientName) => {
                if (!userId) {
                    setAppMessage('Please sign in to send swap requests.');
                    setIsAppMessageModalOpen(true);
                    return;
                }
                setSelectedRecipientId(recipientId);
                setSelectedRecipientName(recipientName);
                setShowSwapRequestModal(true);
            }, [userId]);

            const handleProfileUpdate = useCallback((updatedProfile) => {
                console.log("Profile updated:", updatedProfile);
                // In a real app, you might re-fetch the userProfile in AuthProvider
                // or have AuthProvider provide a setter for userProfile.
                // For this example, the AuthProvider's useEffect will re-fetch on userId change.
            }, []);

            if (!isAuthReady) {
                return <LoadingSpinner />;
            }

            if (!currentUser) {
                return (
                    <div className={`min-h-screen bg-${theme.bg} font-sans text-${theme.text} flex items-center justify-center`}>
                        {showAuthForm === 'login' ? (
                            <LoginForm
                                onLoginSuccess={() => setCurrentPage('browse')}
                                onSwitchToSignup={() => setShowAuthForm('signup')}
                            />
                        ) : (
                            <SignupForm
                                onSignupSuccess={() => setShowAuthForm('login')}
                                onSwitchToLogin={() => setShowAuthForm('login')}
                            />
                        )}
                    </div>
                );
            }

            return (
                <div className={`min-h-screen bg-${theme.bg} font-sans text-${theme.text}`}>
                    <header className={`bg-${theme.headerBg} text-${theme.headerText} p-4 shadow-md`}>
                        <div className="container mx-auto flex flex-wrap justify-between items-center">
                            <h1 className="text-2xl font-bold">Skill Swap Platform</h1>
                            <nav className="mt-2 md:mt-0">
                                <ul className="flex flex-wrap space-x-4">
                                    <li>
                                        <button
                                            onClick={() => setCurrentPage('browse')}
                                            className={`px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'browse' ? `bg-${theme.primary}-800` : `hover:bg-${theme.primary}-600`}`}
                                        >
                                            Browse Skills
                                        </button>
                                    </li>
                                    <li>
                                        <button
                                            onClick={() => setCurrentPage('profile')}
                                            className={`px-3 py-2 rounded-sm text-sm font-medium ${currentPage === 'profile' ? `bg-${theme.primary}-800` : `hover:bg-${theme.primary}-600`}`}
                                        >
                                            My Profile
                                        </button>
                                    </li>
                                    <li>
                                        <button
                                            onClick={() => setCurrentPage('requests')}
                                            className={`px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'requests' ? `bg-${theme.primary}-800` : `hover:bg-${theme.primary}-600`}`}
                                        >
                                            Swap Requests
                                        </button>
                                    </li>
                                    {userProfile?.is_admin && (
                                        <li>
                                            <button
                                                onClick={() => setCurrentPage('admin')}
                                                className={`px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'admin' ? `bg-${theme.primary}-800` : `hover:bg-${theme.primary}-600`}`}
                                            >
                                                Admin
                                            </button>
                                        </li>
                                    )}
                                    <li>
                                        <button
                                            onClick={logout}
                                            className={`px-3 py-2 rounded-md text-sm font-medium hover:bg-${theme.primary}-600`}
                                        >
                                            Sign Out
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </header>

                    {platformWideMessage && (
                        <div className={`bg-${theme.secondary}-100 border-l-4 border-${theme.secondary}-500 text-${theme.secondary}-700 p-4 mt-4 mx-auto max-w-4xl rounded-md shadow-sm`} role="alert">
                            <p className="font-bold">Platform Announcement:</p>
                            <p>{platformWideMessage}</p>
                        </div>
                    )}

                    <main className="container mx-auto px-4 py-8">
                        {userId && (
                            <div className={`text-center mb-4 text-sm text-${theme.text}`}>
                                Your User ID: <span className={`font-mono bg-${theme.primary}-200 px-2 py-1 rounded-md`}>{userId}</span>
                            </div>
                        )}

                        {currentPage === 'browse' && <BrowseUsers onSendSwapRequest={handleSendSwapRequest} />}
                        {currentPage === 'profile' && userId && userProfile && (
                            <ProfileEditor
                                userProfile={userProfile}
                                userId={userId}
                                onProfileUpdate={handleProfileUpdate}
                            />
                        )}
                        {currentPage === 'requests' && <SwapRequests />}
                        {currentPage === 'admin' && <AdminPanel />}
                    </main>

                    <SwapRequestForm
                        isOpen={showSwapRequestModal}
                        onClose={() => setShowSwapRequestModal(false)}
                        recipientId={selectedRecipientId}
                        recipientName={selectedRecipientName}
                    />
                    <MessageModal isOpen={isAppMessageModalOpen} onClose={() => setIsAppMessageModalOpen(false)} message={appMessage} />
                </div>
            );
        };

        // Render the Root component
        const Root = () => (
            <AuthProvider>
                <App />
            </AuthProvider>
        );

        ReactDOM.render(<Root />, document.getElementById('root'));
    </script>
</body >
</html >

